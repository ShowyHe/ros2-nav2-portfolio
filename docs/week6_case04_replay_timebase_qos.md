# Week6 Case04 — Replay / Timebase / QoS（回放链路类故障）

## 0）Case 定位
1. Case 名称：Replay / Timebase / QoS（回放观测链路不一致导致的系统性假异常）
2. 目标：固定回放链路的判定与修复闭环，避免把 timebase/QoS 问题误判为导航算法问题
3. 适用范围：ros2 bag 回放（含 --loop/--clock）+ Nav2/RViz/TF/Map 等订阅链路

---

## 1）现象
1. 回放时出现“显示/行为不稳定”：
   - RViz 画面闪烁、显示丢失、局部/全局轨迹间歇性断裂
   - TF 查询超时或间歇性不可用
2. 回放时出现“看似导航异常”：
   - 导航行为与实时运行显著不一致
   - 评估结果不稳定或不可复现
3. 上述现象具有强相关性：一旦时间源或 QoS 不一致，多个模块同时出现异常。

---

## 2）证据
### 2.1 时间源污染：/clock 发布者不唯一
1. 判据：`/clock` Publisher count 必须为 1
2. 典型证据形态：
   - `/clock` 发布者数量 > 1 时，系统时间推进出现竞争/冲突
   - 直接后果：TF/RViz/订阅端出现抖动与不稳定

### 2.2 时间回拨：--loop 导致时间跳变
1. 判据：回放开启 `--loop` 后，时间会从末尾回到起点产生回拨
2. 典型证据形态：
   - RViz 显示闪烁/丢显示
   - 依赖时间单调性的模块出现间歇性异常

### 2.3 Map 订阅 QoS 不匹配：/map “收不到”
1. 判据：回放与 RViz/订阅端必须在 QoS 上匹配，尤其是 Durability
2. 典型证据形态：
   - bag 中 /map 可能只出现少量消息（甚至仅 1 条），如果订阅端 Durability 不匹配，会长期显示 “No map received”
   - 修复后立即恢复 /map 显示与依赖 map 的功能

---

## 3）根因判断
1. 结论级判断：回放链路的首要风险是 timebase/QoS，不一致会制造“系统性假异常”。
2. 根因类型划分：
   1) 时间源冲突（/clock 发布者不唯一）→ 时间推进不确定 → TF/RViz/订阅链路整体不稳定
   2) 时间回拨（--loop）→ 时间非单调 → 可视化与依赖时间的模块出现闪烁/丢失/间歇性异常
   3) QoS 不匹配（/map durability 等）→ 订阅端拿不到关键数据 → 诱发连锁异常
3. 判断原则：只要 timebase/QoS 未满足基本健康条件，任何“导航异常”都不具备可解释性，应先修复观测链路。

---

## 4）修复动作清单与验证口径
### 4.1 验证口径（健康条件）
1. `/clock` Publisher count = 1
2. TF 稳定可用（查询不超时，数据持续刷新）
3. `/map` Publisher count ≥ 1 且订阅端 QoS 匹配（Durability=Transient Local 为常见必要条件）
4. RViz 显示稳定（不闪烁、不丢 Map/轨迹）

### 4.2 修复动作清单
1. 清理时间源冲突
   - 确保系统中只有一个 `/clock` 发布者
   - 避免在同一回放中引入重复时间源
2. 规避时间回拨影响
   - 回放时优先避免使用导致回拨的配置
   - 必须使用循环时，明确其对可视化与时间相关模块的影响，并以健康条件为验收
3. 修正 /map 的订阅 QoS
   - 将订阅端（例如 RViz 的 Map Display）QoS Durability 设置为 Transient Local（与发布侧一致）
   - 确保回放包含必要话题：`/map`、`/tf`、`/tf_static` 等
4. 统一 use_sim_time
   - 所有依赖回放时间的节点必须使用仿真时间（use_sim_time=true），避免真实时间与回放时间混用

---

## 5）复现入口
1. 入口A：回放数据（bag）
   - 回放时带上关键话题：`/clock /tf /tf_static /scan /map /odom`
2. 入口B：订阅端（RViz/其他节点）
   - use_sim_time=true
   - Map Display QoS Durability 与发布侧匹配
3. 入口C：健康检查
   - /clock 发布者数量检查
   - TF 连续性检查
   - /map 发布与 QoS 检查

---

## 6）结论
1. 回放链路的异常优先视为 timebase/QoS 问题：只要 `/clock` 不干净或 QoS 不匹配，任何上层行为异常都不具备可解释性。
2. 修复应遵循固定闭环：先满足健康条件（/clock 唯一、TF 稳、/map QoS 匹配、RViz 稳定），再讨论上层模块表现。
3. 在健康条件未达标前，回放产生的数据与现象应判定为不可用观测，不用于评估或对比结论。
