# Week6 Case05 — Localization / Initialization（AMCL 未收敛导致数据污染）

## 0）Case 定位
1. Case 名称：Localization / Initialization（定位未收敛 → 运行数据污染）
2. 目标：固定“定位收敛”的规约与判定标准，并给出一个可落到具体 run 的实际例子
3. 数据范围：
   - Week5 Map3 runs（用于提供实例锚点与 BT 区间）
   - 定位证据来源：/amcl_pose（或 particlecloud）、map→odom TF 连续性、costmap 对齐一致性

---

## 1）现象
1. 定位未收敛阶段启动导航或开始记录，会出现行为与数据异常：
   - 位姿估计不稳定，表现为姿态/位置抖动或跳变
   - local/global costmap 与地图对齐不一致，出现错位与漂移
2. 同一场景重复运行结果波动大：
   - time_sec、recovery_hits、是否超时等指标不可重复或难以解释
3. 现象具有“污染性”：
   - runs 的统计值会混入“定位系统自救时间/纠偏行为”，使数据不再代表导航性能本身

---

## 2）证据
### 2.1 证据类型（定位侧）
1. `/amcl_pose`（或 particlecloud）在启动后短时间内显著波动或跳变
2. map→odom TF 不稳定：
   - 变换间歇不可用，或数值出现明显跳变
3. RViz 对齐异常：
   - 机器人模型与地图/障碍明显不贴合
   - local costmap 与环境障碍不一致，出现“看似空旷却高代价/被封路”

### 2.2 实际例子（落到具体 run）
1. 实例锚点：Map3 run1  
   - result=T，time_sec=120.000  
   - bt_start_line=0，bt_end_line=30641  
   - recovery_types=ClearLocalCostmap;ClearGlobalCostmap;Spin;BackUp，recovery_hits=18
2. 例子含义：
   - 该 run 的 BT 区间为可检查窗口；若在该窗口早期出现 `/amcl_pose` 大幅波动或 map→odom 跳变，则该 run 的 time_sec 与 recovery 行为将被“定位自救过程”显著污染。
3. 判定规则：
   - 若 run1 在起始阶段满足“未收敛证据”（/amcl_pose 明显波动、map→odom 跳变、costmap 对齐异常）中的任意两项，则该 run 作为“定位污染样本”归档，不纳入性能对比与结论。

---

## 3）根因判断
1. 结论级判断：定位未收敛会把 runs 统计污染成“定位系统自救 + 导航系统行为”的混合结果。
2. 根因链条：
   1) AMCL 需要从初始位姿与传感器匹配中逐步收敛
   2) 收敛前 map→odom 不稳定，导致全局系与局部系对齐关系不可靠
   3) costmap、规划与控制在不可靠位姿/TF 上工作，诱发异常恢复与行为抖动
   4) 统计指标混入收敛过程，失去可解释性与可比性

---

## 4）修复动作清单与验证口径
### 4.1 验证口径（收敛判定三连）
1. 位姿稳定性：`/amcl_pose` 在连续一段时间内不再明显跳变
2. TF 稳定性：map→odom 连续可用且数值变化平滑，无明显回跳
3. 对齐一致性：RViz 中机器人与地图/障碍对齐一致，local costmap 与环境匹配

### 4.2 修复动作清单（规约化）
1. 初始位姿流程固定化：每次运行开始前设置初始位姿并进入收敛等待窗口
2. 收敛后再开始记录与导航：runs 计时与记录从“收敛判定三连通过”之后开始
3. 无效样本剔除：运行中若重设初始位姿或出现明显定位漂移，该 run 直接判为无效样本并重跑
4. 时间一致性：use_sim_time 全链一致，避免真实时间与仿真/回放时间混用

### 4.3 验证方式（最小验证）
1. 每次 run 前执行“收敛判定三连”
2. 三连通过才允许进入结果统计；未通过直接不记录或标记为无效样本

---

## 5）复现入口
1. 入口A（实例窗口）：Map3 run1 的 BT 区间（bt_start_line=0 至 bt_end_line=30641）
2. 入口B（检查对象）：
   - `/amcl_pose`（或 particlecloud）
   - map→odom TF 连续性
   - RViz 对齐一致性（机器人与地图/障碍，local costmap 是否一致）
3. 入口C（判定输出）：
   - 若满足未收敛证据 → 标记为“定位污染样本”
   - 若三连通过 → 允许计入统计

---

## 6）结论
1. 定位未收敛会系统性污染 runs：统计值混入定位自救过程，不能代表导航性能本身。
2. 必须把“收敛判定三连”作为硬前置条件：未通过即判无效样本，不纳入对比与结论。
3. 本 Case 给出可落到具体 run 的实例锚点（Map3 run1 + BT 区间）；通过该窗口检查定位稳定性即可完成“污染判定”闭环。
